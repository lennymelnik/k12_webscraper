define(["underscore","jquery","postal","FooTable","container.view","./datatable.model","widget.registry.service","base.service","session"],function(e,t,n,r,i,s,o,u,a){"use strict";return i.extend({template:"datatable.widget.hbs",ModelClass:s,easyInitialize:!0,$footable:null,returnedRowGroups:0,rowGroupCount:0,groups:[],hasRenderedNoContentMessage:!1,events:{"click table > thead th > a":"_sortDataClick","click table > tfoot td button":"_footerClick"},subviewDefs:{"> table > thead":{view:"component.group.widget",dataKey:"headers"}},initialize:function(){i.prototype.initialize.apply(this,arguments),this.subscribeChannel("dataTable."+this.cid+".redrawFootableDetailsRow","renderComplete",e.bindKey(this,"_redrawFootableDetailsRow"))},afterRender:function(){var t=this.model.get("data"),n=this.model.get("hasRows"),r=this;if(n){var i=this.$el.find("> table > tbody")[0].children;e.each(t,function(e,t){this._insertRow(e,this._rowRegionByIndex(t),i[t])},this)}else t.components&&(r.spinTable(!0),e.each(t.components,function(e){r.groups.push(e.id),r._getRowGroup(e),r.rowGroupCount++}),this.model.set("data",[],{silent:!0}));this._finalizeTable(),this._highlightColumn()},spinTable:function(e){this.nextGenSpinner(e)},_finalizeTable:function(){this._insertFooter(),this._initFootable(),this._initTooltips(),this._renderNoContentMessage()},_handleDataArray:function(t){var n=this.$el.find("> table > tbody")[0].children;e.each(t,function(e,t){this._insertRow(e,this._rowRegionByIndex(t),n[t])},this)},_getRowGroup:function(e){var t=this;if(!this.loadEnabled(e)){if(this.loadEnabledCheckCount<this.authexternalCheckMaxCount){var n=window.setTimeout(function(){t._getRowGroup(e)},t.loadEnabledCheckInterval);GLOBALS.timeouts.push(n)}else debug.warn("Max time ("+this.authexternalCheckMaxCount+" seconds) reached for Auth External calls. Giving up.");this.loadEnabledCheckCount>=this.loadEnabledCheckMaxCount&&!t.spinnerStopped&&(t.spinnerStopped=!0,debug.warn("Max time ("+this.loadEnabledCheckMaxCount+" seconds) reached for showing spinner for this widget. Hiding spinner."),t.spinTable(!1)),this.loadEnabledCheckCount++}else u.doGET(e.updateUrl,{}).done(function(n){t.appendRows(n.data,!1,e.id)}).fail(function(){}).always(function(){t.returnedRowGroups++,t._allEndpointsReturned()&&(t._finalizeTable(),t.spinTable(!1))})},_allEndpointsReturned:function(){return this.rowGroupCount===this.returnedRowGroups},resize:function(){this.$footable&&this.$footable.trigger("footable_resize")},appendRows:function(n,r,i){var s=this.$el.find("tbody"),o=this.model.get("data"),u=e.isArray(o)?o.length:0;Array.prototype.push.apply(o,n),e.each(n,function(e,n){var r=t("<tr></tr>");i&&r.addClass(i),s.append(r),e.rowId=n+u,this._insertRow(e,this._rowRegionByIndex(e.rowId),r)},this),r&&(this.model.set("footer",r,{silent:!0}),this._insertFooter()),this.groups.length>0&&e.each(this.groups,function(e){var t=s.find("tr."+e);t.length!==0&&t.detach().appendTo(s)}),this.$footable&&this.$footable.trigger("footable_redraw"),this._initTooltips()},_insertRow:function(e,t,r){var i=this.regions[t];i?i.destroyData():(i=o.getInstance("component.group.widget",{channel:n.channel("dataTable."+this.cid+".redrawFootableDetailsRow"),channelPayload:{rowId:e.rowId}}),this.addView(t,i)),this.setView(t,r),i.model.set(this._rowParser(e))},_insertFooter:function(){var e="> table > tfoot > tr > td",t,n=this.model.get("footer");if(!n)return;n.url?(t=o.getInstance("Button"),n.link={},n.link.url=n.url,n.link.textStyle="button-label font-lg",n.link.analyticsEvents=n.analyticsEvents,n.style="datatable-more btn-default btn-block btn-lg effeckt-button"):(t=o.getInstance("Link"),n.textStyle="message",this.$el.find(e).addClass("datatable-footer")),this.addView(e,t),this.setView(e),t.model.set(n)},_sortDataClick:function(e){e.preventDefault();var n={fragment:t(e.currentTarget).data().url};this.trigger("reloadModel",n),console.log("_sortDataClick!!!: "+e)},_footerClick:function(e){e.preventDefault();var n={bookmarkable:!1,fragment:t(e.currentTarget).data().url};this.trigger("reloadModel",n)},_footerButtonParser:function(e){return e.mute=!0,e.link={},e.link.url=e.url,e},_rowParser:function(e){return e=e||{},e.groupContainerTag=!1,e.itemContainerTag="td",e},_initFootable:function(){var e=this;this.$footable=this.$el.children("table"),this.$footable.footable({breakpoints:{phone:0,tablet:0,xs:575,sm:701,md:901},classes:{striping:{odd:"color-background-white",even:"color-background-off-white"}}}).bind("footable_row_detail_updated",function(n){t(n.detail).find(".gh-auto-tooltip").removeData("bs.tooltip");var r=t(n.row).prevAll(":not(.footable-row-detail)").length;e._triggerProgressiveLoad(r)}),a.isNextgen()&&(this.$el.find(".progress-bar-container").addClass("pbar"),this.$el.find(".progress-bar").addClass("progress-bar-striped"))},_redrawFootableDetailsRow:function(t){var n;this.$footable&&(n=this.$footable.data("footable"));if(n&&e.isObject(t)){var r=this.regions[this._rowRegionByIndex(t.rowId)],i=r&&r.$el;i&&(i.data("detail_created",!1),n.createOrUpdateDetailRow(i))}},_rowRegionByIndex:function(e){return"> table > tbody > tr:nth-child("+(e+1)+")"},_triggerProgressiveLoad:function(t){var n=this.regions[this._rowRegionByIndex(t)];n?e.each(n.regions,function(e){e.model.get("updateOnDemand")&&e.triggerProgressiveLoad()}):debug.log("Datatable widget unable to trigger progressive load!")},_highlightColumn:function(){var t=this.model.get("columns"),n=this;e.each(t,function(e,t){e.config&&e.config.highlight&&n.$el.addClass("highlight"+t)})},_renderNoContentMessage:function(){if(GLOBALS.ENVIRONMENT.experience==="nextgen"){var e=this.model.get("emptyMessage"),n=this.$el,r=n.find("tbody td").length;if(e&&r<1&&!this.hasRenderedNoContentMessage&&this._allEndpointsReturned()){this.hasRenderedNoContentMessage=!0;var i=t('<tr><td class="empty-message" colspan="'+this.model.get("columnCount")+'"><div><span>'+e+"</span></div></td></tr>");n.find("tbody").append(i),n.addClass("is-empty"),debug.log(this.cid+" - renderNoContentMessage(): "+e)}}}})});